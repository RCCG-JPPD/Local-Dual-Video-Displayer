<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Controller</title>
  <style>
    body { font-family: sans-serif; margin:20px; }
    #playlist { width:100%; height:180px; }
    button, input[type=range] { margin:4px; }
    #time { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <h2>Playlist</h2>
  <select id="playlist" size="10"></select><br>
  <button id="addBtn">Add…</button>
  <button id="removeBtn">Remove</button>
  <hr>

  <button id="prevBtn">⏮︎ Prev</button>
  <button id="playBtn">▶︎/⏸︎</button>
  <button id="nextBtn">Next ⏭︎</button>
  <br>

  <input id="scrub" type="range" min="0" max="100" value="0" style="width:60%">
  <span id="time">00:00 / 00:00</span>
  <br>

  Volume <input id="vol" type="range" min="0" max="1" step="0.01" value="1" style="width:200px">

  <script>
  const { ipcRenderer } = require('electron');

  const playlistSel = document.getElementById('playlist');
  const scrub       = document.getElementById('scrub');
  const timeLabel   = document.getElementById('time');
  const volSlider   = document.getElementById('vol');
  const playBtn     = document.getElementById('playBtn');

  let playlist = [], idx = -1, isPlaying=false, duration=0;

  // ────────── FILE PICKER ──────────
  document.getElementById('addBtn').onclick = async () => {
    const files = await ipcRenderer.invoke('open-file-dialog');
    files.forEach(f => playlist.push(f));
    renderList();
    if (idx === -1 && playlist.length) load(0);
  };
  document.getElementById('removeBtn').onclick = () => {
    if (idx>-1) { playlist.splice(idx,1); if (idx>=playlist.length) idx--; renderList(); load(idx); }
  };

  function renderList(){
    playlistSel.innerHTML = playlist.map((p,i)=>
      `<option value="${i}" ${i===idx?'selected':''}>${pathBasename(p)}</option>`).join('');
  }
  function pathBasename(p){ return p.split(/[\\/]/).pop(); }

  // ────────── LOAD / PLAYBACK CONTROL ──────────
  function send(cmd,data){ ipcRenderer.send('controller-command',cmd,data); }
  function load(i){
    if (i==null || i<0 || i>=playlist.length) return;
    idx = i; renderList();
    send('load', playlist[idx]);
    isPlaying = true; playBtn.textContent='⏸︎';
  }

  playBtn.onclick = () => {
    if (idx===-1) return;
    if (isPlaying){ send('pause'); isPlaying=false; playBtn.textContent='▶︎'; }
    else           { send('play');  isPlaying=true;  playBtn.textContent='⏸︎'; }
  };
  document.getElementById('prevBtn').onclick = ()=> load((idx-1+playlist.length)%playlist.length);
  document.getElementById('nextBtn').onclick = ()=> load((idx+1)%playlist.length);

  // ────────── SCRUB BAR ──────────
  scrub.oninput = ()=> send('seek', scrub.value * duration / 100);

  ipcRenderer.on('video-time', (_e, now, dur)=>{
    duration = dur;
    if (!scrub.dragging) scrub.value = (now/dur)*100 || 0;
    timeLabel.textContent = fmt(now)+' / '+fmt(dur);
  });
  function fmt(t){
    if (isNaN(t)) return '00:00';
    const m = Math.floor(t/60).toString().padStart(2,'0');
    const s = Math.floor(t%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }

  // ────────── VOLUME ──────────
  volSlider.oninput = ()=> send('setVolume', parseFloat(volSlider.value));
  </script>
</body>
</html>